js:
  help: the javascript app
  dependencies:
    - app.coffee
    - '*.coffee'
    - package.json
  output:
    - assets/bundle.js
  formula: >
    . ../test/base.sh;
    ./node_modules/.bin/browserifyinc -t coffeeify -t envify --extension='.coffee' app.coffee > assets/bundle.js

css:
  help: the less file to css
  dependencies:
    - scss/*.scss
  output:
    - assets/bundle.css
  formula: >
    scss --sourcemap=none scss/main.scss assets/bundle.css

html:
  help: turn .md files into .html files
  dependencies:
    - base.html
    - landing.html
  output:
    - index.html
  formula: >
    cat base.html | py -l "'\n'.join(l).split('<!--app-->')[0]" > index.html;
    cat landing.html >> index.html;
    cat base.html | py -l "'\n'.join(l).split('<!--app-->')[1]" >> index.html;
    cp base.html account/index.html

prod:
  help: build and minify files
  dependencies:
    - assets/bundle.css
    - index.html
    - account/index.html
    - app.coffee
  output:
    - assets/b.min.js
    - assets/bundle.prod.js
    - assets/b.min.js.map
    - assets/b.min.css
    - prod-index.html
    - account/prod-index.html
  formula: >
    env $(cat ../.prod.env | xargs) ./node_modules/.bin/browserify -t coffeeify -t envify --extension='.coffee' app.coffee > assets/bundle.prod.js;
    ./node_modules/.bin/uglifyjs assets/bundle.prod.js -o assets/b.min.js --source-map-root http://websitesfortrello.com/ --source-map assets/b.min.js.map --source-map-url http://websitesfortrello.com/assets/b.min.js.map;
    ./node_modules/.bin/cleancss -o assets/b.min.css assets/bundle.css;
    sed -e 's/bundle\./b.min./' index.html > prod-index.html;
    sed -e 's/bundle\./b.min./' account/index.html > account/prod-index.html;

s3:
  help: uploads app to s3
  dependencies:
    - assets/bundle.prod.js
    - assets/b.min.js
    - assets/b.min.js.map
    - assets/*
    - account/*
    - prod-index.html
  formula: >
    s3cmd sync --acl-public --delete-removed --exclude-from .s3ignore . s3://websitesfortrello.com/
